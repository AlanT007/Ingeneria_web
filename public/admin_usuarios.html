<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administrador</title>
  <style>
    body { 
    font-family: Arial; 
    background: #f5f5f5; 
    padding: 20px; }
    table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-top: 20px; }
    th, td { 
    border: 1px solid #ccc; 
    padding: 8px; 
    text-align: center; }
    th { 
    background: #ddd; }
    input, select { 
    width: 95%; 
    padding: 5px; }
    button { 
    margin: 2px; 
    padding: 5px 10px; }
    #msg { 
    margin-top: 15px; 
    font-weight: bold; }
  </style>
</head>
<body>
  <h1>Panel del Administrador</h1>
  <h2>Usuarios registrados</h2>
  <table id="tablaUsuarios">
    <thead>
      <tr>
        <th>ID</th>
        <th>Usuario</th>
        <th>Password</th>
        <th>Rol</th>
        <th>Opciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Crear nuevo usuario</h2>
  <input type="text" id="nuevoUsuario" placeholder="Usuario">
  <input type="password" id="nuevoPassword" placeholder="ContraseÃ±a">
  <select id="nuevoRol">
    <option value="cliente">Cliente</option>
    <option value="operador">Operador</option>
    <option value="admin">Administrador</option>
  </select>
  <button onclick="crearUsuario()">Crear</button>

  <p id="msg"></p>

  <script>
  function getToken() {
    return localStorage.getItem("token");
  }

  async function cargarUsuarios() {
    const res = await fetch("/admin/usuarios", {
      headers: { "Authorization": "Bearer " + getToken() }
    });
    const data = await res.json();
    const tbody = document.querySelector("#tablaUsuarios tbody");
    tbody.innerHTML = "";

    if (!data.usuarios) {
      document.getElementById("msg").textContent = data.msg || "Error cargando usuarios";
      return;
    }

    data.usuarios.forEach(u => {
      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${u._id}</td>
        <td><input value="${u.usuario}" id="user-${u._id}"></td>
        <td><input value="${u.password}" id="pass-${u._id}"></td>
        <td>
          <select id="rol-${u._id}">
            <option value="cliente" ${u.rol === "cliente" ? "selected" : ""}>Cliente</option>
            <option value="operador" ${u.rol === "operador" ? "selected" : ""}>Operador</option>
            <option value="admin" ${u.rol === "admin" ? "selected" : ""}>Administrador</option>
          </select>
        </td>
        <td>
          <button onclick="editarUsuario('${u._id}')">Editar</button>
          <button onclick="eliminarUsuario('${u._id}')">Eliminar</button>
        </td>
      `;
      tbody.appendChild(fila);
    });
  }

  async function crearUsuario() {
    const usuario = document.getElementById("nuevoUsuario").value;
    const password = document.getElementById("nuevoPassword").value;
    const rol = document.getElementById("nuevoRol").value;
    const msg = document.getElementById("msg");

    const res = await fetch("/admin/usuarios", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": "Bearer " + getToken()
      },
      body: JSON.stringify({ usuario, password, rol })
    });

    const data = await res.json();
    msg.textContent = data.msg;
    cargarUsuarios();
  }

  async function editarUsuario(id) {
    const usuario = document.getElementById(`user-${id}`).value;
    const password = document.getElementById(`pass-${id}`).value;
    const rol = document.getElementById(`rol-${id}`).value;
    const msg = document.getElementById("msg");

    const res = await fetch(`/admin/usuarios/${id}`, {
      method: "PUT",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": "Bearer " + getToken()
      },
      body: JSON.stringify({ usuario, password, rol })
    });

    const data = await res.json();
    msg.textContent = data.msg;
    cargarUsuarios();
  }

  async function eliminarUsuario(id) {
    const res = await fetch(`/admin/usuarios/${id}`, { 
      method: "DELETE",
      headers: { "Authorization": "Bearer " + getToken() }
    });
    const data = await res.json();
    const msg = document.getElementById("msg");
    msg.textContent = data.msg;
    cargarUsuarios();
  }

  cargarUsuarios();
</script>
</body>
</html>
